#version=RHEL10

# Enable serial console for both installer and installed system
console --device ttyS0 --speed 115200
bootloader --location=mbr --append="console=ttyS0,115200n8 console=tty0"

# System language and keyboard
lang en_US.UTF-8
keyboard us
zerombr yes

# Network configuration (DHCP on first interface)
network --bootproto=dhcp --device=link --onboot=on --activate

# Timezone
timezone Australia/Brisbane --isUtc

# Root account
rootpw --plaintext changeme

# Optional non-root user
user --name=almalinux --groups=wheel --plaintext changeme --gecos "AlmaLinux User"
# Allow wheel group to sudo without password
%wheel ALL=(ALL) NOPASSWD: ALL

# Disk partitioning
autopart --type=lvm

# Package selection
%packages
@^minimal-environment
cloud-init
NetworkManager
openssh-server
%end

# Pre-installation script: ping over serial so we know we've entered %pre
%pre
# redirect all STDIO to the serial console
exec </dev/ttyS0 >/dev/ttyS0 2>&1
echo "=== KS PRE start ===" > /dev/ttyS0
%end

# Post-install configuration and instrumentation
%post --log=/root/ks-post.log --interpreter=/usr/bin/bash
# redirect all STDIO to the serial console
exec </dev/ttyS0 >/dev/ttyS0 2>&1

echo "=== KS POST start: enabling services ===" > /dev/ttyS0

# Enable SSH and networking
sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
systemctl enable sshd
systemctl enable NetworkManager
systemctl enable cloud-final.service

echo "=== KS POST end: services enabled ===" > /dev/ttyS0
%end

# Reboot into the installed system
reboot
