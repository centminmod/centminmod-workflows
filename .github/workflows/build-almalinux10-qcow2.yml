name: 0 - Build AlmaLinux 10 QCOW2 Image

on:
  workflow_dispatch:

jobs:
  build-qcow2:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients unzip

      - name: Setup Packer
        uses: hashicorp/setup-packer@v2
        with:
          version: '1.11.3'

      - name: Download ISO & extract checksum
        run: |
          ISO_URL=https://repo.almalinux.org/almalinux/10.0/isos/x86_64_v2/AlmaLinux-10-latest-x86_64_v2-minimal.iso
          ISO_NAME=${ISO_URL##*/}
          curl -sSL -o "$ISO_NAME" "$ISO_URL"
          curl -sSL https://repo.almalinux.org/almalinux/10.0/isos/x86_64_v2/CHECKSUM -o CHECKSUM

          # Match "SHA256 (<filename>) = <hash>" and grab field 4
          ISO_CHECKSUM=$(grep "SHA256 (${ISO_NAME})" CHECKSUM | awk '{print $4}')

          echo "ISO_NAME=$ISO_NAME"   >> $GITHUB_ENV
          echo "ISO_CHECKSUM=$ISO_CHECKSUM" >> $GITHUB_ENV

      - name: Build QCOW2 with Packer
        run: |
          packer init packer/almalinux10.pkr.hcl
          packer build \
            -only=qemu.almalinux_kitten_10_gencloud_x86_64 \
            -var iso_url="file://${{ github.workspace }}/${{ env.ISO_NAME }}" \
            -var iso_checksum="${{ env.ISO_CHECKSUM }}" \
            packer/almalinux10.pkr.hcl

      - uses: actions/upload-artifact@v4
        with:
          name: almalinux-10-qcow2
          path: build/almalinux10/*.qcow2
